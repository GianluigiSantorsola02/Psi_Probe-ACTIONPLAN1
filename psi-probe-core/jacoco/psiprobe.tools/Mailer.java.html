<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Mailer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe.tools</a> &gt; <span class="el_source">Mailer.java</span></div><h1>Mailer.java</h1><pre class="source lang-java linenums">/**
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe.tools;

import java.io.PrintStream;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Properties;

import javax.activation.DataHandler;
import javax.activation.DataSource;
import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.Part;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.AddressException;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeBodyPart;
import javax.mail.internet.MimeMessage;
import javax.mail.internet.MimeMultipart;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;

/**
 * Facade for sending emails with the JavaMail API.
 */
public class Mailer {

  /** The Constant PROPERTY_KEY_SMTP. */
  public static final String PROPERTY_KEY_SMTP = &quot;mail.smtp.host&quot;;

  /** The Constant logger. */
<span class="fc" id="L45">  private static final Logger logger = LoggerFactory.getLogger(Mailer.class);</span>

  /** The from. */
  private String from;

  /** The smtp. */
  private String smtp;

  /** The default to. */
  private String defaultTo;

  /** The subject prefix. */
  private String subjectPrefix;

  /**
   * Instantiates a new mailer.
   */
  public Mailer() {
<span class="fc" id="L63">    this(null);</span>
<span class="fc" id="L64">  }</span>

  /**
   * Instantiates a new mailer.
   *
   * @param from the from
   */
  public Mailer(String from) {
<span class="fc" id="L72">    this(from, null);</span>
<span class="fc" id="L73">  }</span>

  /**
   * Instantiates a new mailer.
   *
   * @param from the from
   * @param smtp the smtp
   */
<span class="fc" id="L81">  public Mailer(String from, String smtp) {</span>
<span class="fc" id="L82">    this.smtp = smtp;</span>
<span class="fc" id="L83">    this.from = from;</span>
<span class="fc" id="L84">  }</span>

  /**
   * Gets the from.
   *
   * @return the from
   */
  public String getFrom() {
<span class="fc" id="L92">    return from;</span>
  }

  /**
   * Gets the smtp.
   *
   * @return the smtp
   */
  public String getSmtp() {
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">    if (smtp == null) {</span>
<span class="nc" id="L102">      return System.getProperty(PROPERTY_KEY_SMTP);</span>
    }
<span class="fc" id="L104">    return smtp;</span>
  }

  /**
   * Sets the from.
   *
   * @param from the new from
   */
  public void setFrom(String from) {
<span class="fc" id="L113">    this.from = from;</span>
<span class="fc" id="L114">  }</span>

  /**
   * Sets the smtp.
   *
   * @param smtp the new smtp
   */
  public void setSmtp(String smtp) {
<span class="fc" id="L122">    this.smtp = smtp;</span>
<span class="fc" id="L123">  }</span>

  /**
   * Gets the default to.
   *
   * @return the default to
   */
  public String getDefaultTo() {
<span class="fc" id="L131">    return defaultTo;</span>
  }

  /**
   * Sets the default to.
   *
   * @param defaultTo the new default to
   */
  @Value(&quot;${psiprobe.tools.mail.to}&quot;)
  public void setDefaultTo(String defaultTo) {
<span class="fc" id="L141">    this.defaultTo = defaultTo;</span>
<span class="fc" id="L142">  }</span>

  /**
   * Gets the subject prefix.
   *
   * @return the subject prefix
   */
  public String getSubjectPrefix() {
<span class="fc" id="L150">    return subjectPrefix;</span>
  }

  /**
   * Sets the subject prefix.
   *
   * @param subjectPrefix the new subject prefix
   */
  @Value(&quot;${psiprobe.tools.mail.subjectPrefix}&quot;)
  public void setSubjectPrefix(String subjectPrefix) {
<span class="fc" id="L160">    this.subjectPrefix = subjectPrefix;</span>
<span class="fc" id="L161">  }</span>

  /**
   * Send.
   *
   * @param mailMessage the mail message
   * @throws MessagingException the messaging exception
   */
  public void send(MailMessage mailMessage) throws MessagingException {
<span class="nc" id="L170">    Properties props = (Properties) System.getProperties().clone();</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">    if (smtp != null) {</span>
<span class="nc" id="L172">      props.put(PROPERTY_KEY_SMTP, smtp);</span>
    }

<span class="nc" id="L175">    try (PrintStream debugOut =</span>
<span class="nc" id="L176">        LogOutputStream.createPrintStream(logger, LogOutputStream.LEVEL_DEBUG)) {</span>
<span class="nc" id="L177">      Session session = Session.getDefaultInstance(props);</span>
<span class="nc" id="L178">      session.setDebug(true);</span>
<span class="nc" id="L179">      session.setDebugOut(debugOut);</span>

<span class="nc" id="L181">      MimeMessage message = createMimeMessage(session, mailMessage);</span>
<span class="nc" id="L182">      logger.debug(&quot;Sending message&quot;);</span>
<span class="nc" id="L183">      Transport.send(message);</span>
    }
<span class="nc" id="L185">  }</span>

  /**
   * Creates the mime message.
   *
   * @param session the session
   * @param mailMessage the mail message
   * @return the mime message
   * @throws MessagingException the messaging exception
   */
  private MimeMessage createMimeMessage(Session session, MailMessage mailMessage)
      throws MessagingException {

<span class="nc" id="L198">    String subject = mailMessage.getSubject();</span>
<span class="nc bnc" id="L199" title="All 4 branches missed.">    if (subjectPrefix != null &amp;&amp; !subjectPrefix.isEmpty()) {</span>
<span class="nc" id="L200">      subject = subjectPrefix + &quot; &quot; + subject;</span>
    }

<span class="nc" id="L203">    MimeMultipart content = new MimeMultipart(&quot;related&quot;);</span>

    // Create attachments
<span class="nc" id="L206">    DataSource[] attachments = mailMessage.getAttachmentsArray();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">    for (DataSource attachment : attachments) {</span>
<span class="nc" id="L208">      MimeBodyPart attachmentPart = createAttachmentPart(attachment);</span>
<span class="nc" id="L209">      content.addBodyPart(attachmentPart);</span>
    }

    // Create message body
<span class="nc" id="L213">    MimeBodyPart bodyPart = createMessageBodyPart(mailMessage.getBody(), mailMessage.isBodyHtml());</span>
<span class="nc" id="L214">    content.addBodyPart(bodyPart);</span>

<span class="nc" id="L216">    MimeMessage message = new MimeMessage(session);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">    if (from == null) {</span>
      // Uses mail.from property
<span class="nc" id="L219">      message.setFrom();</span>
    } else {
<span class="nc" id="L221">      message.setFrom(new InternetAddress(from));</span>
    }

<span class="nc" id="L224">    InternetAddress[] to = createAddresses(mailMessage.getToArray());</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">    if (to.length == 0) {</span>
<span class="nc" id="L226">      to = InternetAddress.parse(defaultTo);</span>
    }
<span class="nc" id="L228">    message.setRecipients(Message.RecipientType.TO, to);</span>

<span class="nc" id="L230">    InternetAddress[] cc = createAddresses(mailMessage.getCcArray());</span>
<span class="nc" id="L231">    message.setRecipients(Message.RecipientType.CC, cc);</span>

<span class="nc" id="L233">    InternetAddress[] bcc = createAddresses(mailMessage.getBccArray());</span>
<span class="nc" id="L234">    message.setRecipients(Message.RecipientType.BCC, bcc);</span>

<span class="nc" id="L236">    message.setSubject(subject);</span>
<span class="nc" id="L237">    message.setContent(content);</span>
<span class="nc" id="L238">    return message;</span>
  }

  /**
   * Creates the addresses.
   *
   * @param addresses the addresses
   * @return the Internet address[]
   * @throws AddressException the address exception
   */
  private static InternetAddress[] createAddresses(String[] addresses) throws AddressException {
<span class="nc" id="L249">    List&lt;InternetAddress&gt; result = new ArrayList&lt;&gt;(addresses.length);</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">    for (String address : addresses) {</span>
<span class="nc" id="L251">      InternetAddress[] parsedAddresses = InternetAddress.parse(address);</span>
<span class="nc" id="L252">      result.addAll(Arrays.asList(parsedAddresses));</span>
    }
<span class="nc" id="L254">    return result.toArray(new InternetAddress[result.size()]);</span>
  }

  /**
   * Creates the attachment part.
   *
   * @param attachment the attachment
   * @return the mime body part
   * @throws MessagingException the messaging exception
   */
  private static MimeBodyPart createAttachmentPart(DataSource attachment)
      throws MessagingException {

<span class="nc" id="L267">    MimeBodyPart attachmentPart = new MimeBodyPart();</span>
<span class="nc" id="L268">    attachmentPart.setDataHandler(new DataHandler(attachment));</span>
<span class="nc" id="L269">    attachmentPart.setDisposition(Part.ATTACHMENT);</span>
<span class="nc" id="L270">    attachmentPart.setFileName(attachment.getName());</span>
<span class="nc" id="L271">    return attachmentPart;</span>
  }

  /**
   * Creates the message body part.
   *
   * @param body the body
   * @param html the html
   * @return the mime body part
   * @throws MessagingException the messaging exception
   */
  private static MimeBodyPart createMessageBodyPart(String body, boolean html)
      throws MessagingException {
<span class="nc" id="L284">    MimeBodyPart bodyPart = new MimeBodyPart();</span>
<span class="nc" id="L285">    bodyPart.setText(body);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">    bodyPart.setHeader(&quot;content-type&quot;, html ? &quot;text/html&quot; : &quot;text/plain&quot;);</span>
<span class="nc" id="L287">    return bodyPart;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>