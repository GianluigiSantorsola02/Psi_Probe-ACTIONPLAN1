<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractTomcatContainer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe</a> &gt; <span class="el_source">AbstractTomcatContainer.java</span></div><h1>AbstractTomcatContainer.java</h1><pre class="source lang-java linenums">/**
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe;

import java.io.File;
import java.io.IOException;
import java.lang.management.ManagementFactory;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URL;
import java.net.URLClassLoader;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import javax.management.MBeanServer;
import javax.management.MalformedObjectNameException;
import javax.management.ObjectName;
import javax.naming.NamingException;
import javax.servlet.ServletConfig;
import javax.servlet.ServletContext;

import org.apache.catalina.Container;
import org.apache.catalina.Context;
import org.apache.catalina.Engine;
import org.apache.catalina.Host;
import org.apache.catalina.Service;
import org.apache.catalina.Valve;
import org.apache.catalina.Wrapper;
import org.apache.catalina.connector.Connector;
import org.apache.catalina.core.StandardContext;
import org.apache.jasper.EmbeddedServletOptions;
import org.apache.jasper.JspCompilationContext;
import org.apache.jasper.Options;
import org.apache.jasper.compiler.JspRuntimeContext;
import org.apache.naming.ContextBindings;
import org.apache.naming.factory.ResourceLinkFactory;
import org.apache.tomcat.util.descriptor.web.ContextResourceLink;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.util.ClassUtils;

import psiprobe.beans.ResourceResolverBean;
import psiprobe.model.FilterMapping;
import psiprobe.model.jsp.Item;
import psiprobe.model.jsp.Summary;

/**
 * Abstraction layer to implement some functionality, which is common between different container
 * adapters.
 */
<span class="nc" id="L64">public abstract class AbstractTomcatContainer implements TomcatContainer {</span>

  /** The logger. */
<span class="nc" id="L67">  protected final Logger logger = LoggerFactory.getLogger(getClass());</span>

  /** The Constant NO_JSP_SERVLET. */
  private static final String NO_JSP_SERVLET = &quot;Context '{}' does not have 'JSP' servlet&quot;;

  /** The host. */
  protected Host host;

  /** The connectors. */
  protected Connector[] connectors;

  /** The deployer o name. */
  protected ObjectName deployerOName;

  /** The mbean server. */
  protected MBeanServer mbeanServer;

  /** The Enum FilterMapType. */
<span class="nc" id="L85">  public enum FilterMapType {</span>

    /** The url. */
<span class="nc" id="L88">    URL,</span>

    /** The servlet name. */
<span class="nc" id="L91">    SERVLET_NAME;</span>
  }

  @Override
  public void setWrapper(Wrapper wrapper) {
<span class="nc" id="L96">    Valve valve = createValve();</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">    if (wrapper != null) {</span>
<span class="nc" id="L98">      host = (Host) wrapper.getParent().getParent();</span>
<span class="nc" id="L99">      Engine engine = (Engine) host.getParent();</span>
<span class="nc" id="L100">      Service service = engine.getService();</span>
<span class="nc" id="L101">      connectors = service.findConnectors();</span>
      try {
<span class="nc" id="L103">        deployerOName =</span>
<span class="nc" id="L104">            new ObjectName(host.getParent().getName() + &quot;:type=Deployer,host=&quot; + host.getName());</span>
<span class="nc" id="L105">      } catch (MalformedObjectNameException e) {</span>
<span class="nc" id="L106">        logger.trace(&quot;&quot;, e);</span>
<span class="nc" id="L107">      }</span>
<span class="nc" id="L108">      host.getPipeline().addValve(valve);</span>
<span class="nc" id="L109">      mbeanServer = ManagementFactory.getPlatformMBeanServer();</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">    } else if (host != null) {</span>
<span class="nc" id="L111">      host.getPipeline().removeValve(valve);</span>
    }
<span class="nc" id="L113">  }</span>

  @Override
  public File getAppBase() {
<span class="nc" id="L117">    File base = new File(host.getAppBase());</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">    if (!base.isAbsolute()) {</span>
<span class="nc" id="L119">      base = new File(System.getProperty(&quot;catalina.base&quot;), host.getAppBase());</span>
    }
<span class="nc" id="L121">    return base;</span>
  }

  @Override
  public String getConfigBase() {
<span class="nc" id="L126">    File configBase = new File(System.getProperty(&quot;catalina.base&quot;), &quot;conf&quot;);</span>
<span class="nc" id="L127">    Container baseHost = null;</span>
<span class="nc" id="L128">    Container thisContainer = host;</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">    while (thisContainer != null) {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">      if (thisContainer instanceof Host) {</span>
<span class="nc" id="L131">        baseHost = thisContainer;</span>
      }
<span class="nc" id="L133">      thisContainer = thisContainer.getParent();</span>
    }
<span class="nc bnc" id="L135" title="All 2 branches missed.">    if (baseHost != null) {</span>
<span class="nc" id="L136">      configBase = new File(configBase, baseHost.getName());</span>
    }
<span class="nc" id="L138">    return configBase.getAbsolutePath();</span>
  }

  @Override
  public String getHostName() {
<span class="nc" id="L143">    return host.getName();</span>
  }

  @Override
  public String getName() {
<span class="nc" id="L148">    return host.getParent().getName();</span>
  }

  @Override
  public List&lt;Context&gt; findContexts() {
<span class="nc" id="L153">    List&lt;Context&gt; results = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">    for (Container child : host.findChildren()) {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">      if (child instanceof Context) {</span>
<span class="nc" id="L156">        results.add((Context) child);</span>
      }
    }
<span class="nc" id="L159">    return results;</span>
  }

  @Override
  public List&lt;Connector&gt; findConnectors() {
<span class="nc" id="L164">    return Collections.unmodifiableList(Arrays.asList(connectors));</span>
  }

  @Override
  public boolean installContext(String contextName) throws Exception {
<span class="nc" id="L169">    contextName = formatContextName(contextName);</span>
<span class="nc" id="L170">    installContextInternal(contextName);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">    return findContext(contextName) != null;</span>
  }

  @Override
  public void stop(String name) throws Exception {
<span class="nc" id="L176">    Context ctx = findContext(name);</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">    if (ctx != null) {</span>
<span class="nc" id="L178">      ctx.stop();</span>
    }
<span class="nc" id="L180">  }</span>

  @Override
  public void start(String name) throws Exception {
<span class="nc" id="L184">    Context ctx = findContext(name);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">    if (ctx != null) {</span>
<span class="nc" id="L186">      ctx.start();</span>
    }
<span class="nc" id="L188">  }</span>

  @Override
  public void remove(String name) throws Exception {
<span class="nc" id="L192">    name = formatContextName(name);</span>
<span class="nc" id="L193">    Context ctx = findContext(name);</span>

<span class="nc bnc" id="L195" title="All 2 branches missed.">    if (ctx != null) {</span>

      try {
<span class="nc" id="L198">        stop(name);</span>
<span class="nc" id="L199">      } catch (Exception e) {</span>
<span class="nc" id="L200">        logger.info(&quot;Stopping '{}' threw this exception:&quot;, name, e);</span>
<span class="nc" id="L201">      }</span>

      File appDir;
<span class="nc" id="L204">      File docBase = new File(ctx.getDocBase());</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">      if (!docBase.isAbsolute()) {</span>
<span class="nc" id="L207">        appDir = new File(getAppBase(), ctx.getDocBase());</span>
      } else {
<span class="nc" id="L209">        appDir = docBase;</span>
      }

<span class="nc" id="L212">      logger.debug(&quot;Deleting '{}'&quot;, appDir.getAbsolutePath());</span>
<span class="nc" id="L213">      Utils.delete(appDir);</span>

<span class="nc" id="L215">      String warFilename = formatContextFilename(name);</span>
<span class="nc" id="L216">      File warFile = new File(getAppBase(), warFilename + &quot;.war&quot;);</span>
<span class="nc" id="L217">      logger.debug(&quot;Deleting '{}'&quot;, warFile.getAbsolutePath());</span>
<span class="nc" id="L218">      Utils.delete(warFile);</span>

<span class="nc" id="L220">      File configFile = getConfigFile(ctx);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">      if (configFile != null) {</span>
<span class="nc" id="L222">        logger.debug(&quot;Deleting '{}'&quot;, configFile.getAbsolutePath());</span>
<span class="nc" id="L223">        Utils.delete(configFile);</span>
      }

<span class="nc" id="L226">      removeInternal(name);</span>
    }
<span class="nc" id="L228">  }</span>

  /**
   * Removes the internal.
   *
   * @param name the name
   * @throws Exception the exception
   */
  private void removeInternal(String name) throws Exception {
<span class="nc" id="L237">    checkChanges(name);</span>
<span class="nc" id="L238">  }</span>

  @Override
  public void installWar(String name, URL url) throws Exception {
<span class="nc" id="L242">    checkChanges(name);</span>
<span class="nc" id="L243">  }</span>

  /**
   * Install context internal.
   *
   * @param name the name
   * @throws Exception the exception
   */
  private void installContextInternal(String name) throws Exception {
<span class="nc" id="L252">    checkChanges(name);</span>
<span class="nc" id="L253">  }</span>

  @Override
  public Context findContext(String name) {
<span class="nc" id="L257">    String safeName = formatContextName(name);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">    if (safeName == null) {</span>
<span class="nc" id="L259">      return null;</span>
    }
<span class="nc" id="L261">    Context result = findContextInternal(safeName);</span>
<span class="nc bnc" id="L262" title="All 4 branches missed.">    if (result == null &amp;&amp; &quot;&quot;.equals(safeName)) {</span>
<span class="nc" id="L263">      result = findContextInternal(&quot;/&quot;);</span>
    }
<span class="nc" id="L265">    return result;</span>
  }

  @Override
  public String formatContextName(String name) {
<span class="nc bnc" id="L270" title="All 2 branches missed.">    if (name == null) {</span>
<span class="nc" id="L271">      return null;</span>
    }
<span class="nc" id="L273">    String result = name.trim();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">    if (!result.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L275">      result = &quot;/&quot; + result;</span>
    }
<span class="nc bnc" id="L277" title="All 4 branches missed.">    if (&quot;/&quot;.equals(result) || &quot;/ROOT&quot;.equals(result)) {</span>
<span class="nc" id="L278">      result = &quot;&quot;;</span>
    }
    // For ROOT Parallel Deployment, remove &quot;/ROOT&quot;
<span class="nc bnc" id="L281" title="All 2 branches missed.">    if (result.startsWith(&quot;/ROOT##&quot;)) {</span>
<span class="nc" id="L282">      result = result.substring(5);</span>
    }
    // For ROOT Parallel Usage, remove &quot;/&quot;
<span class="nc bnc" id="L285" title="All 2 branches missed.">    if (result.startsWith(&quot;/##&quot;)) {</span>
<span class="nc" id="L286">      result = result.substring(1);</span>
    }
<span class="nc" id="L288">    return result;</span>
  }

  @Override
  public String formatContextFilename(String contextName) {
<span class="nc bnc" id="L293" title="All 2 branches missed.">    if (contextName == null) {</span>
<span class="nc" id="L294">      return null;</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">    } else if (&quot;&quot;.equals(contextName)) {</span>
<span class="nc" id="L296">      return &quot;ROOT&quot;;</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">    } else if (contextName.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L298">      return contextName.substring(1);</span>
    } else {
<span class="nc" id="L300">      return contextName;</span>
    }
  }

  @Override
  public void discardWorkDir(Context context) {
<span class="nc bnc" id="L306" title="All 2 branches missed.">    if (context instanceof StandardContext) {</span>
<span class="nc" id="L307">      StandardContext standardContext = (StandardContext) context;</span>
<span class="nc" id="L308">      String path = standardContext.getWorkPath();</span>
<span class="nc" id="L309">      logger.info(&quot;Discarding '{}'&quot;, path);</span>
<span class="nc" id="L310">      Utils.delete(new File(path, &quot;org&quot;));</span>
<span class="nc" id="L311">    } else {</span>
<span class="nc" id="L312">      logger.error(&quot;context '{}' is not an instance of '{}', expected StandardContext&quot;,</span>
<span class="nc" id="L313">          context.getName(), context.getClass().getName());</span>
    }
<span class="nc" id="L315">  }</span>

  @Override
  public String getServletFileNameForJsp(Context context, String jspName) {
<span class="nc" id="L319">    String servletName = null;</span>

<span class="nc" id="L321">    ServletConfig servletConfig = (ServletConfig) context.findChild(&quot;jsp&quot;);</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">    if (servletConfig != null) {</span>
<span class="nc" id="L323">      ServletContext sctx = context.getServletContext();</span>
<span class="nc" id="L324">      Options opt = new EmbeddedServletOptions(servletConfig, sctx);</span>
<span class="nc" id="L325">      JspRuntimeContext jrctx = new JspRuntimeContext(sctx, opt);</span>
<span class="nc" id="L326">      JspCompilationContext jcctx = createJspCompilationContext(jspName, opt, sctx, jrctx, null);</span>
<span class="nc" id="L327">      servletName = jcctx.getServletJavaFileName();</span>
<span class="nc" id="L328">    } else {</span>
<span class="nc" id="L329">      logger.error(NO_JSP_SERVLET, context.getName());</span>
    }
<span class="nc" id="L331">    return servletName;</span>
  }

  @Override
  public void recompileJsps(Context context, Summary summary, List&lt;String&gt; names) {
<span class="nc" id="L336">    ServletConfig servletConfig = (ServletConfig) context.findChild(&quot;jsp&quot;);</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">    if (servletConfig != null) {</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">      if (summary != null) {</span>
<span class="nc" id="L339">        synchronized (servletConfig) {</span>
<span class="nc" id="L340">          ServletContext sctx = context.getServletContext();</span>
<span class="nc" id="L341">          Options opt = new EmbeddedServletOptions(servletConfig, sctx);</span>

<span class="nc" id="L343">          JspRuntimeContext jrctx = new JspRuntimeContext(sctx, opt);</span>
          /*
           * we need to pass context classloader here, so the jsps can reference /WEB-INF/classes
           * and /WEB-INF/lib. JspCompilationContext would only take URLClassLoader, so we fake it
           */
<span class="nc" id="L348">          try (URLClassLoader classLoader =</span>
<span class="nc" id="L349">              new URLClassLoader(new URL[0], context.getLoader().getClassLoader())) {</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">            for (String name : names) {</span>
<span class="nc" id="L351">              long time = System.currentTimeMillis();</span>
<span class="nc" id="L352">              JspCompilationContext jcctx =</span>
<span class="nc" id="L353">                  createJspCompilationContext(name, opt, sctx, jrctx, classLoader);</span>
<span class="nc" id="L354">              ClassLoader prevCl = ClassUtils.overrideThreadContextClassLoader(classLoader);</span>
              try {
<span class="nc" id="L356">                Item item = summary.getItems().get(name);</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">                if (item != null) {</span>
                  try {
<span class="nc" id="L359">                    org.apache.jasper.compiler.Compiler compiler = jcctx.createCompiler();</span>
<span class="nc" id="L360">                    compiler.compile();</span>
<span class="nc" id="L361">                    item.setState(Item.STATE_READY);</span>
<span class="nc" id="L362">                    item.setException(null);</span>
<span class="nc" id="L363">                    logger.info(&quot;Compiled '{}': OK&quot;, name);</span>
<span class="nc" id="L364">                  } catch (Exception e) {</span>
<span class="nc" id="L365">                    item.setState(Item.STATE_FAILED);</span>
<span class="nc" id="L366">                    item.setException(e);</span>
<span class="nc" id="L367">                    logger.error(&quot;Compiled '{}': FAILED&quot;, name, e);</span>
<span class="nc" id="L368">                  }</span>
<span class="nc" id="L369">                  item.setCompileTime(System.currentTimeMillis() - time);</span>
                } else {
<span class="nc" id="L371">                  logger.error(&quot;{} is not on the summary list, ignored&quot;, name);</span>
                }
              } finally {
<span class="nc" id="L374">                ClassUtils.overrideThreadContextClassLoader(prevCl);</span>
              }
<span class="nc" id="L376">            }</span>
<span class="nc" id="L377">          } catch (IOException e) {</span>
<span class="nc" id="L378">            this.logger.error(&quot;&quot;, e);</span>
          } finally {
<span class="nc" id="L380">            jrctx.destroy();</span>
          }
<span class="nc" id="L382">        }</span>
      } else {
<span class="nc" id="L384">        logger.error(&quot;summary is null for '{}', request ignored&quot;, context.getName());</span>
      }
    } else {
<span class="nc" id="L387">      logger.error(NO_JSP_SERVLET, context.getName());</span>
    }
<span class="nc" id="L389">  }</span>

  @Override
  public void listContextJsps(Context context, Summary summary, boolean compile) {
<span class="nc" id="L393">    ServletConfig servletConfig = (ServletConfig) context.findChild(&quot;jsp&quot;);</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">    if (servletConfig != null) {</span>
<span class="nc" id="L395">      synchronized (servletConfig) {</span>
<span class="nc" id="L396">        ServletContext sctx = context.getServletContext();</span>
<span class="nc" id="L397">        Options opt = new EmbeddedServletOptions(servletConfig, sctx);</span>

<span class="nc" id="L399">        JspRuntimeContext jrctx = new JspRuntimeContext(sctx, opt);</span>
        try {
<span class="nc bnc" id="L401" title="All 2 branches missed.">          if (summary.getItems() == null) {</span>
<span class="nc" id="L402">            summary.setItems(new HashMap&lt;&gt;());</span>
          }

          /*
           * mark all items as missing
           */
<span class="nc bnc" id="L408" title="All 2 branches missed.">          for (Item item : summary.getItems().values()) {</span>
<span class="nc" id="L409">            item.setMissing(true);</span>
<span class="nc" id="L410">          }</span>

          /*
           * we need to pass context classloader here, so the jsps can reference /WEB-INF/classes
           * and /WEB-INF/lib. JspCompilationContext would only take URLClassLoader, so we fake it
           */
<span class="nc" id="L416">          try (URLClassLoader urlcl =</span>
<span class="nc" id="L417">              new URLClassLoader(new URL[0], context.getLoader().getClassLoader())) {</span>

<span class="nc" id="L419">            compileItem(&quot;/&quot;, opt, context, jrctx, summary, urlcl, 0, compile);</span>
<span class="nc" id="L420">          } catch (IOException e) {</span>
<span class="nc" id="L421">            this.logger.error(&quot;&quot;, e);</span>
<span class="nc" id="L422">          }</span>
        } finally {
<span class="nc" id="L424">          jrctx.destroy();</span>
        }
<span class="nc" id="L426">      }</span>

      //
      // delete &quot;missing&quot; items by keeping &quot;not missing&quot; ones
      //
<span class="nc" id="L431">      Map&lt;String, Item&gt; hashMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">      for (String key : summary.getItems().keySet()) {</span>
<span class="nc" id="L433">        Item item = summary.getItems().get(key);</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">        if (!item.isMissing()) {</span>
<span class="nc" id="L435">          hashMap.put(key, item);</span>
        }
<span class="nc" id="L437">      }</span>

<span class="nc" id="L439">      summary.setItems(hashMap);</span>
<span class="nc" id="L440">    } else {</span>
<span class="nc" id="L441">      logger.error(NO_JSP_SERVLET, context.getName());</span>
    }
<span class="nc" id="L443">  }</span>

  @Override
  public boolean getAvailable(Context context) {
<span class="nc" id="L447">    return context.getState().isAvailable();</span>
  }

  @Override
  public File getConfigFile(Context context) {
<span class="nc" id="L452">    URL configUrl = context.getConfigFile();</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">    if (configUrl != null) {</span>
      try {
<span class="nc" id="L455">        URI configUri = configUrl.toURI();</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">        if (&quot;file&quot;.equals(configUri.getScheme())) {</span>
<span class="nc" id="L457">          return new File(configUri.getPath());</span>
        }
<span class="nc" id="L459">      } catch (URISyntaxException ex) {</span>
<span class="nc" id="L460">        logger.error(&quot;Could not convert URL to URI: '{}'&quot;, configUrl, ex);</span>
<span class="nc" id="L461">      }</span>
    }
<span class="nc" id="L463">    return null;</span>
  }

  @Override
  public void bindToContext(Context context) throws NamingException {
<span class="nc" id="L468">    changeContextBinding(context, true);</span>
<span class="nc" id="L469">  }</span>

  @Override
  public void unbindFromContext(Context context) throws NamingException {
<span class="nc" id="L473">    changeContextBinding(context, false);</span>
<span class="nc" id="L474">  }</span>

  /**
   * Register access to global resources.
   *
   * @param resourceLink the resource link
   */
  protected void registerGlobalResourceAccess(ContextResourceLink resourceLink) {
<span class="nc" id="L482">    ResourceLinkFactory.registerGlobalResourceAccess(ResourceResolverBean.getGlobalNamingContext(),</span>
<span class="nc" id="L483">        resourceLink.getName(), resourceLink.getGlobal());</span>
<span class="nc" id="L484">  }</span>

  /**
   * Change context binding.
   *
   * @param context the context
   * @param bind the bind
   * @throws NamingException the naming exception
   */
  private void changeContextBinding(Context context, boolean bind) throws NamingException {
<span class="nc" id="L494">    Object token = getNamingToken(context);</span>
<span class="nc" id="L495">    ClassLoader loader = Thread.currentThread().getContextClassLoader();</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">    if (bind) {</span>
<span class="nc" id="L497">      ContextBindings.bindClassLoader(context, token, loader);</span>
    } else {
<span class="nc" id="L499">      ContextBindings.unbindClassLoader(context, token, loader);</span>
    }
<span class="nc" id="L501">  }</span>

  /**
   * Lists and optionally compiles a directory recursively.
   *
   * @param jspName name of JSP file or directory to be listed and compiled.
   * @param opt the JSP compiler options
   * @param ctx the context
   * @param jrctx the runtime context used to create the compilation context
   * @param summary the summary in which the output is stored
   * @param classLoader the classloader used by the compiler
   * @param level the depth in the tree at which the item was encountered
   * @param compile whether or not to compile the item or just to check whether it's out of date
   */
  protected void compileItem(String jspName, Options opt, Context ctx, JspRuntimeContext jrctx,
      Summary summary, URLClassLoader classLoader, int level, boolean compile) {
<span class="nc" id="L517">    ServletContext sctx = ctx.getServletContext();</span>
<span class="nc" id="L518">    Set&lt;String&gt; paths = sctx.getResourcePaths(jspName);</span>

<span class="nc bnc" id="L520" title="All 2 branches missed.">    if (paths != null) {</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">      for (String name : paths) {</span>
<span class="nc" id="L522">        boolean isJsp = false;</span>

        try {
<span class="nc" id="L525">          isJsp =</span>
<span class="nc bnc" id="L526" title="All 6 branches missed.">              name.endsWith(&quot;.jsp&quot;) || name.endsWith(&quot;.jspx&quot;) || opt.getJspConfig().isJspPage(name);</span>
<span class="nc" id="L527">        } catch (Exception e) {</span>
          // XXX Tomcat 7.0.x throws JasperException otherwise this could be removed.
<span class="nc" id="L529">          logger.info(&quot;isJspPage() thrown an error for '{}'&quot;, name, e);</span>
<span class="nc" id="L530">        }</span>

<span class="nc bnc" id="L532" title="All 2 branches missed.">        if (isJsp) {</span>
<span class="nc" id="L533">          JspCompilationContext jcctx =</span>
<span class="nc" id="L534">              createJspCompilationContext(name, opt, sctx, jrctx, classLoader);</span>
<span class="nc" id="L535">          ClassLoader prevCl = ClassUtils.overrideThreadContextClassLoader(classLoader);</span>
          try {
<span class="nc" id="L537">            Item item = summary.getItems().get(name);</span>

<span class="nc bnc" id="L539" title="All 2 branches missed.">            if (item == null) {</span>
<span class="nc" id="L540">              item = new Item();</span>
<span class="nc" id="L541">              item.setName(name);</span>
            }

<span class="nc" id="L544">            item.setLevel(level);</span>
<span class="nc" id="L545">            item.setCompileTime(-1);</span>

<span class="nc" id="L547">            Long[] objects = this.getResourceAttributes(name, ctx);</span>
<span class="nc" id="L548">            item.setSize(objects[0]);</span>
<span class="nc" id="L549">            item.setLastModified(objects[1]);</span>

<span class="nc" id="L551">            long time = System.currentTimeMillis();</span>
            try {
<span class="nc" id="L553">              org.apache.jasper.compiler.Compiler compiler = jcctx.createCompiler();</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">              if (compile) {</span>
<span class="nc" id="L555">                compiler.compile();</span>
<span class="nc" id="L556">                item.setState(Item.STATE_READY);</span>
<span class="nc" id="L557">                item.setException(null);</span>
              } else {
<span class="nc bnc" id="L559" title="All 2 branches missed.">                if (!compiler.isOutDated()) {</span>
<span class="nc" id="L560">                  item.setState(Item.STATE_READY);</span>
<span class="nc" id="L561">                  item.setException(null);</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">                } else if (item.getState() != Item.STATE_FAILED) {</span>
<span class="nc" id="L563">                  item.setState(Item.STATE_OOD);</span>
<span class="nc" id="L564">                  item.setException(null);</span>
                }
              }
<span class="nc" id="L567">              logger.info(&quot;Compiled '{}': OK&quot;, name);</span>
<span class="nc" id="L568">            } catch (Exception e) {</span>
<span class="nc" id="L569">              item.setState(Item.STATE_FAILED);</span>
<span class="nc" id="L570">              item.setException(e);</span>
<span class="nc" id="L571">              logger.info(&quot;Compiled '{}': FAILED&quot;, name, e);</span>
<span class="nc" id="L572">            }</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">            if (compile) {</span>
<span class="nc" id="L574">              item.setCompileTime(System.currentTimeMillis() - time);</span>
            }
<span class="nc" id="L576">            item.setMissing(false);</span>
<span class="nc" id="L577">            summary.getItems().put(name, item);</span>
          } finally {
<span class="nc" id="L579">            ClassUtils.overrideThreadContextClassLoader(prevCl);</span>
          }
<span class="nc" id="L581">        } else {</span>
<span class="nc" id="L582">          compileItem(name, opt, ctx, jrctx, summary, classLoader, level + 1, compile);</span>
        }
<span class="nc" id="L584">      }</span>
    } else {
<span class="nc" id="L586">      logger.debug(&quot;getResourcePaths() is null for '{}'. Empty dir? Or Tomcat bug?&quot;, jspName);</span>
    }
<span class="nc" id="L588">  }</span>

  /**
   * Find context internal.
   *
   * @param name the context name
   * @return the context
   */
  protected Context findContextInternal(String name) {
<span class="nc" id="L597">    return (Context) host.findChild(name);</span>
  }

  /**
   * Check changes.
   *
   * @param name the name
   * @throws Exception the exception
   */
  protected void checkChanges(String name) throws Exception {
<span class="nc" id="L607">    Boolean result = (Boolean) mbeanServer.invoke(deployerOName, &quot;isServiced&quot;, new String[] {name},</span>
<span class="nc" id="L608">        new String[] {String.class.getName()});</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">    if (!result.booleanValue()) {</span>
<span class="nc" id="L610">      mbeanServer.invoke(deployerOName, &quot;addServiced&quot;, new String[] {name},</span>
<span class="nc" id="L611">          new String[] {String.class.getName()});</span>
      try {
<span class="nc" id="L613">        mbeanServer.invoke(deployerOName, &quot;check&quot;, new String[] {name},</span>
<span class="nc" id="L614">            new String[] {String.class.getName()});</span>
      } finally {
<span class="nc" id="L616">        mbeanServer.invoke(deployerOName, &quot;removeServiced&quot;, new String[] {name},</span>
<span class="nc" id="L617">            new String[] {String.class.getName()});</span>
      }
    }
<span class="nc" id="L620">  }</span>

  /**
   * Returns the security token required to bind to a naming context.
   *
   * @param context the catalina context
   * @return the security token for use with &lt;code&gt;ContextBindings&lt;/code&gt;
   */
  protected abstract Object getNamingToken(Context context);

  /**
   * Creates the jsp compilation context.
   *
   * @param name the name
   * @param opt the opt
   * @param sctx the sctx
   * @param jrctx the jrctx
   * @param classLoader the class loader
   * @return the jsp compilation context
   */
  protected abstract JspCompilationContext createJspCompilationContext(String name, Options opt,
      ServletContext sctx, JspRuntimeContext jrctx, ClassLoader classLoader);

  /**
   * Creates the valve.
   *
   * @return the valve
   */
  protected abstract Valve createValve();

  /**
   * Adds the filter mapping.
   *
   * @param filterName the filter name
   * @param dispatcherMap the dispatcher map
   * @param filterClass the filter class
   * @param types the types as urls or servlet name
   * @param results the results
   * @param filterMapType the filter map type
   */
  protected void addFilterMapping(String filterName, String dispatcherMap, String filterClass,
      String[] types, List&lt;FilterMapping&gt; results, FilterMapType filterMapType) {
<span class="nc bnc" id="L662" title="All 2 branches missed.">    for (String type : types) {</span>
<span class="nc" id="L663">      FilterMapping fm = new FilterMapping();</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">      if (filterMapType == FilterMapType.URL) {</span>
<span class="nc" id="L665">        fm.setUrl(type);</span>
      } else {
<span class="nc" id="L667">        fm.setServletName(type);</span>
      }
<span class="nc" id="L669">      fm.setFilterName(filterName);</span>
<span class="nc" id="L670">      fm.setDispatcherMap(dispatcherMap);</span>
<span class="nc" id="L671">      fm.setFilterClass(filterClass);</span>
<span class="nc" id="L672">      results.add(fm);</span>
    }
<span class="nc" id="L674">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>