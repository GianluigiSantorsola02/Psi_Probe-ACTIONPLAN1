<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LogResolverBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe.beans</a> &gt; <span class="el_source">LogResolverBean.java</span></div><h1>LogResolverBean.java</h1><pre class="source lang-java linenums">/**
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe.beans;

import java.io.File;
import java.io.Serializable;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import javax.inject.Inject;
import javax.servlet.ServletContext;

import org.apache.catalina.Context;
import org.apache.catalina.Loader;
import org.apache.commons.lang3.reflect.MethodUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.ClassUtils;

import psiprobe.model.Application;
import psiprobe.model.DisconnectedLogDestination;
import psiprobe.tools.ApplicationUtils;
import psiprobe.tools.Instruments;
import psiprobe.tools.logging.FileLogAccessor;
import psiprobe.tools.logging.LogDestination;
import psiprobe.tools.logging.catalina.CatalinaLoggerAccessor;
import psiprobe.tools.logging.commons.CommonsLoggerAccessor;
import psiprobe.tools.logging.jdk.Jdk14LoggerAccessor;
import psiprobe.tools.logging.jdk.Jdk14ManagerAccessor;
import psiprobe.tools.logging.log4j.Log4JLoggerAccessor;
import psiprobe.tools.logging.log4j.Log4JManagerAccessor;
import psiprobe.tools.logging.log4j2.Log4J2AppenderAccessor;
import psiprobe.tools.logging.log4j2.Log4J2LoggerConfigAccessor;
import psiprobe.tools.logging.log4j2.Log4J2LoggerContextAccessor;
import psiprobe.tools.logging.log4j2.Log4J2WebLoggerContextUtilsAccessor;
import psiprobe.tools.logging.logback.LogbackFactoryAccessor;
import psiprobe.tools.logging.logback.LogbackLoggerAccessor;
import psiprobe.tools.logging.slf4jlogback.TomcatSlf4jLogbackFactoryAccessor;
import psiprobe.tools.logging.slf4jlogback.TomcatSlf4jLogbackLoggerAccessor;

/**
 * The Class LogResolverBean.
 */
<span class="fc" id="L59">public class LogResolverBean {</span>

  /** The Constant logger. */
<span class="fc" id="L62">  private static final Logger logger = LoggerFactory.getLogger(LogResolverBean.class);</span>

  /** The container wrapper. */
  @Inject
  private ContainerWrapperBean containerWrapper;

  /** The stdout files. */
<span class="fc" id="L69">  private List&lt;String&gt; stdoutFiles = new ArrayList&lt;&gt;();</span>

  /**
   * Gets the container wrapper.
   *
   * @return the container wrapper
   */
  public ContainerWrapperBean getContainerWrapper() {
<span class="nc" id="L77">    return containerWrapper;</span>
  }

  /**
   * Sets the container wrapper.
   *
   * @param containerWrapper the new container wrapper
   */
  public void setContainerWrapper(ContainerWrapperBean containerWrapper) {
<span class="nc" id="L86">    this.containerWrapper = containerWrapper;</span>
<span class="nc" id="L87">  }</span>

  /**
   * Gets the stdout files.
   *
   * @return the stdout files
   */
  public List&lt;String&gt; getStdoutFiles() {
<span class="nc" id="L95">    return stdoutFiles;</span>
  }

  /**
   * Sets the stdout files.
   *
   * @param stdoutFiles the new stdout files
   */
  @Autowired
  public void setStdoutFiles(List&lt;String&gt; stdoutFiles) {
<span class="fc" id="L105">    logger.info(&quot;stdoutFiles {}&quot;, stdoutFiles);</span>
<span class="fc" id="L106">    this.stdoutFiles = stdoutFiles;</span>
<span class="fc" id="L107">  }</span>

  /**
   * Gets the log destinations.
   *
   * @param all the all
   * @return the log destinations
   */
  public List&lt;LogDestination&gt; getLogDestinations(boolean all) {
<span class="nc" id="L116">    List&lt;LogDestination&gt; allAppenders = getAllLogDestinations();</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">    if (allAppenders == null) {</span>
<span class="nc" id="L119">      return null;</span>
    }

    //
    // this list has to guarantee the order in which elements are added
    //
<span class="nc" id="L125">    List&lt;LogDestination&gt; uniqueList = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L126">    AbstractLogComparator cmp = new LogDestinationComparator(all);</span>

<span class="nc" id="L128">    Collections.sort(allAppenders, cmp);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">    for (LogDestination dest : allAppenders) {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">      if (Collections.binarySearch(uniqueList, dest, cmp) &lt; 0) {</span>
<span class="nc bnc" id="L131" title="All 6 branches missed.">        if (all || dest.getFile() == null || dest.getFile().exists()) {</span>
<span class="nc" id="L132">          uniqueList.add(new DisconnectedLogDestination().builder(dest));</span>
        }
      }
<span class="nc" id="L135">    }</span>
<span class="nc" id="L136">    return uniqueList;</span>
  }

  /**
   * Gets the log sources.
   *
   * @param logFile the log file
   * @return the log sources
   */
  public List&lt;LogDestination&gt; getLogSources(File logFile) {
<span class="nc" id="L146">    List&lt;LogDestination&gt; filtered = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L147">    List&lt;LogDestination&gt; sources = getLogSources();</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">    for (LogDestination dest : sources) {</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">      if (logFile.equals(dest.getFile())) {</span>
<span class="nc" id="L150">        filtered.add(dest);</span>
      }
<span class="nc" id="L152">    }</span>
<span class="nc" id="L153">    return filtered;</span>
  }

  /**
   * Gets the log sources.
   *
   * @return the log sources
   */
  public List&lt;LogDestination&gt; getLogSources() {
<span class="nc" id="L162">    List&lt;LogDestination&gt; sources = new LinkedList&lt;&gt;();</span>

<span class="nc" id="L164">    List&lt;LogDestination&gt; allAppenders = getAllLogDestinations();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">    if (allAppenders != null) {</span>
<span class="nc" id="L166">      AbstractLogComparator cmp = new LogSourceComparator();</span>

<span class="nc" id="L168">      Collections.sort(allAppenders, cmp);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">      for (LogDestination dest : allAppenders) {</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (Collections.binarySearch(sources, dest, cmp) &lt; 0) {</span>
<span class="nc" id="L171">          sources.add(new DisconnectedLogDestination().builder(dest));</span>
        }
<span class="nc" id="L173">      }</span>
    }
<span class="nc" id="L175">    return sources;</span>
  }

  /**
   * Gets the all log destinations.
   *
   * @return the all log destinations
   */
  private List&lt;LogDestination&gt; getAllLogDestinations() {
<span class="nc bnc" id="L184" title="All 2 branches missed.">    if (!Instruments.isInitialized()) {</span>
<span class="nc" id="L185">      return null;</span>
    }

<span class="nc" id="L188">    List&lt;LogDestination&gt; allAppenders = new ArrayList&lt;&gt;();</span>

    //
    // interrogate classloader hierarchy
    //
<span class="nc" id="L193">    ClassLoader cl2 = Thread.currentThread().getContextClassLoader().getParent();</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">    while (cl2 != null) {</span>
<span class="nc" id="L195">      interrogateClassLoader(cl2, null, allAppenders);</span>
<span class="nc" id="L196">      cl2 = cl2.getParent();</span>
    }

    //
    // check for known stdout files, such as &quot;catalina.out&quot;
    //
<span class="nc" id="L202">    interrogateStdOutFiles(allAppenders);</span>

    //
    // interrogate webapp classloaders and available loggers
    //
<span class="nc" id="L207">    List&lt;Context&gt; contexts = getContainerWrapper().getTomcatContainer().findContexts();</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">    for (Context ctx : contexts) {</span>
<span class="nc" id="L209">      interrogateContext(ctx, allAppenders);</span>
<span class="nc" id="L210">    }</span>

<span class="nc" id="L212">    return allAppenders;</span>
  }

  /**
   * Gets the log destination.
   *
   * @param logType the log type
   * @param webapp the webapp
   * @param context the context
   * @param root the root
   * @param logName the log name
   * @param logIndex the log index
   * @return the log destination
   */
  public LogDestination getLogDestination(String logType, String webapp, boolean context,
      boolean root, String logName, String logIndex) {

<span class="nc" id="L229">    LogDestination result = null;</span>
<span class="nc" id="L230">    Context ctx = null;</span>
<span class="nc" id="L231">    Application application = null;</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">    if (webapp != null) {</span>
<span class="nc" id="L233">      ctx = getContainerWrapper().getTomcatContainer().findContext(webapp);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">      if (ctx != null) {</span>
<span class="nc" id="L235">        application = ApplicationUtils.getApplication(ctx, getContainerWrapper());</span>
      }
    }

<span class="nc bnc" id="L239" title="All 4 branches missed.">    if (logName != null &amp;&amp; &quot;stdout&quot;.equals(logType)) {</span>
<span class="nc" id="L240">      result = getStdoutLogDestination(logName);</span>
<span class="nc bnc" id="L241" title="All 4 branches missed.">    } else if (ctx != null &amp;&amp; &quot;catalina&quot;.equals(logType)) {</span>
<span class="nc" id="L242">      result = getCatalinaLogDestination(ctx, application);</span>
<span class="nc bnc" id="L243" title="All 6 branches missed.">    } else if (logIndex != null &amp;&amp; (&quot;jdk&quot;.equals(logType) || &quot;log4j&quot;.equals(logType)</span>
<span class="nc bnc" id="L244" title="All 4 branches missed.">        || &quot;log4j2&quot;.equals(logType) || &quot;logback&quot;.equals(logType))</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        || &quot;tomcatSlf4jLogback&quot;.equals(logType)) {</span>
<span class="nc bnc" id="L246" title="All 6 branches missed.">      if (context &amp;&amp; ctx != null &amp;&amp; !&quot;log4j2&quot;.equals(logType)) {</span>
<span class="nc" id="L247">        result = getCommonsLogDestination(ctx, application, logIndex);</span>
<span class="nc bnc" id="L248" title="All 4 branches missed.">      } else if (ctx != null &amp;&amp; &quot;log4j2&quot;.equals(logType)) {</span>
<span class="nc" id="L249">        result = getLog4J2LogDestination(ctx, application, root, logName, logIndex);</span>
      } else {
        ClassLoader cl;
<span class="nc" id="L252">        ClassLoader prevCl = null;</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (ctx != null) {</span>
<span class="nc" id="L254">          cl = ctx.getLoader().getClassLoader();</span>
<span class="nc" id="L255">          prevCl = ClassUtils.overrideThreadContextClassLoader(cl);</span>
        } else {
<span class="nc" id="L257">          cl = Thread.currentThread().getContextClassLoader().getParent();</span>
        }
        try {
<span class="nc bnc" id="L260" title="All 6 branches missed.">          if ((root || logName != null) &amp;&amp; logIndex != null) {</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (&quot;jdk&quot;.equals(logType)) {</span>
<span class="nc" id="L262">              result = getJdk14LogDestination(cl, application, root, logName, logIndex);</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">            } else if (&quot;log4j&quot;.equals(logType)) {</span>
<span class="nc" id="L264">              result = getLog4JLogDestination(cl, application, root, logName, logIndex);</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">            } else if (&quot;logback&quot;.equals(logType)) {</span>
<span class="nc" id="L266">              result = getLogbackLogDestination(cl, application, root, logName, logIndex);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">            } else if (&quot;tomcatSlf4jLogback&quot;.equals(logType)) {</span>
<span class="nc" id="L268">              result = getLogbackTomcatJuliLogDestination(cl, application, root, logName, logIndex);</span>
            }
          }
        } finally {
<span class="nc bnc" id="L272" title="All 2 branches missed.">          if (prevCl != null) {</span>
<span class="nc" id="L273">            ClassUtils.overrideThreadContextClassLoader(prevCl);</span>
          }
        }
      }
    }
<span class="nc" id="L278">    return result;</span>
  }

  /**
   * Interrogate context.
   *
   * @param ctx the ctx
   * @param allAppenders the all appenders
   */
  private void interrogateContext(Context ctx, List&lt;LogDestination&gt; allAppenders) {
<span class="nc" id="L288">    Application application = ApplicationUtils.getApplication(ctx, getContainerWrapper());</span>
<span class="nc" id="L289">    ClassLoader cl = ctx.getLoader().getClassLoader();</span>
<span class="nc" id="L290">    Object contextLogger = ctx.getLogger();</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">    if (contextLogger != null) {</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">      if (contextLogger.getClass().getName().startsWith(&quot;org.apache.commons.logging&quot;)) {</span>
<span class="nc" id="L293">        CommonsLoggerAccessor commonsAccessor = new CommonsLoggerAccessor();</span>
<span class="nc" id="L294">        commonsAccessor.setTarget(contextLogger);</span>
<span class="nc" id="L295">        commonsAccessor.setApplication(application);</span>
<span class="nc" id="L296">        allAppenders.addAll(commonsAccessor.getDestinations());</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">      } else if (contextLogger.getClass().getName().startsWith(&quot;org.apache.catalina.logger&quot;)) {</span>
<span class="nc" id="L298">        CatalinaLoggerAccessor catalinaAccessor = new CatalinaLoggerAccessor();</span>
<span class="nc" id="L299">        catalinaAccessor.setApplication(application);</span>
<span class="nc" id="L300">        catalinaAccessor.setTarget(contextLogger);</span>
<span class="nc" id="L301">        allAppenders.add(catalinaAccessor);</span>
      }

<span class="nc" id="L304">      ServletContext servletContext = ctx.getServletContext();</span>
      try {
<span class="nc" id="L306">        Log4J2LoggerContextAccessor loggerContextAccessor = null;</span>
        try {
<span class="nc" id="L308">          Log4J2WebLoggerContextUtilsAccessor webLoggerContextUtilsAccessor =</span>
              new Log4J2WebLoggerContextUtilsAccessor(cl);
<span class="nc" id="L310">          loggerContextAccessor = webLoggerContextUtilsAccessor.getWebLoggerContext(servletContext);</span>
<span class="nc" id="L311">        } catch (Exception e) {</span>
<span class="nc" id="L312">          logger.debug(&quot;Log4J2LoggerContextAccessor instantiation failed&quot;, e);</span>
<span class="nc" id="L313">        }</span>
<span class="nc" id="L314">        List&lt;Object&gt; loggerContexts = getLoggerContexts(cl);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">        for (Object loggerContext : loggerContexts) {</span>
<span class="nc" id="L316">          Map&lt;String, Object&gt; loggerConfigs = getLoggerConfigs(loggerContext);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">          for (Object loggerConfig : loggerConfigs.values()) {</span>
<span class="nc" id="L318">            Log4J2LoggerConfigAccessor logConfigAccessor = new Log4J2LoggerConfigAccessor();</span>
<span class="nc" id="L319">            logConfigAccessor.setTarget(loggerConfig);</span>
<span class="nc" id="L320">            logConfigAccessor.setApplication(application);</span>
<span class="nc" id="L321">            logConfigAccessor.setContext(true);</span>
<span class="nc" id="L322">            logConfigAccessor.setLoggerContext(loggerContextAccessor);</span>
<span class="nc" id="L323">            Method getAppenders =</span>
<span class="nc" id="L324">                MethodUtils.getAccessibleMethod(loggerConfig.getClass(), &quot;getAppenders&quot;);</span>
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L326">            Map&lt;String, Object&gt; appenders = (Map&lt;String, Object&gt;) getAppenders.invoke(loggerConfig);</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">            for (Object appender : appenders.values()) {</span>
<span class="nc" id="L328">              Log4J2AppenderAccessor appenderAccessor = new Log4J2AppenderAccessor();</span>
<span class="nc" id="L329">              appenderAccessor.setTarget(appender);</span>
<span class="nc" id="L330">              appenderAccessor.setLoggerAccessor(logConfigAccessor);</span>
<span class="nc" id="L331">              appenderAccessor.setApplication(application);</span>
<span class="nc" id="L332">              allAppenders.add(appenderAccessor);</span>
<span class="nc" id="L333">            }</span>
<span class="nc" id="L334">          }</span>
<span class="nc" id="L335">        }</span>
<span class="nc" id="L336">      } catch (Exception e) {</span>
<span class="nc" id="L337">        logger.debug(&quot;getting appenders failed&quot;, e);</span>
<span class="nc" id="L338">      }</span>
    }

<span class="nc bnc" id="L341" title="All 2 branches missed.">    if (application.isAvailable()) {</span>
<span class="nc" id="L342">      ClassLoader prevCl = ClassUtils.overrideThreadContextClassLoader(cl);</span>
      try {
<span class="nc" id="L344">        interrogateClassLoader(cl, application, allAppenders);</span>
<span class="nc" id="L345">      } catch (Exception e) {</span>
<span class="nc" id="L346">        logger.error(</span>
            &quot;Could not interrogate classloader loggers for {}. Enable debug logging to see the trace stack&quot;,
<span class="nc" id="L348">            ctx.getName());</span>
<span class="nc" id="L349">        logger.debug(&quot;&quot;, e);</span>
      } finally {
<span class="nc bnc" id="L351" title="All 2 branches missed.">        if (prevCl != null) {</span>
<span class="nc" id="L352">          ClassUtils.overrideThreadContextClassLoader(prevCl);</span>
        }
      }
    }
<span class="nc" id="L356">  }</span>

  /**
   * Interrogate class loader.
   *
   * @param cl the cl
   * @param application the application
   * @param appenders the appenders
   */
  private void interrogateClassLoader(ClassLoader cl, Application application,
      List&lt;LogDestination&gt; appenders) {

    String applicationName =
<span class="nc bnc" id="L369" title="All 2 branches missed.">        application != null ? &quot;application \&quot;&quot; + application.getName() + &quot;\&quot;&quot; : &quot;server&quot;;</span>

    // check for JDK loggers
    try {
<span class="nc" id="L373">      Jdk14ManagerAccessor jdk14accessor = new Jdk14ManagerAccessor(cl);</span>
<span class="nc" id="L374">      jdk14accessor.setApplication(application);</span>
<span class="nc" id="L375">      appenders.addAll(jdk14accessor.getHandlers());</span>
<span class="nc" id="L376">    } catch (Exception e) {</span>
<span class="nc" id="L377">      logger.debug(&quot;Could not resolve JDK loggers for '{}'&quot;, applicationName, e);</span>
<span class="nc" id="L378">    }</span>

    // check for Log4J loggers
    try {
<span class="nc" id="L382">      Log4JManagerAccessor log4JAccessor = new Log4JManagerAccessor(cl);</span>
<span class="nc" id="L383">      log4JAccessor.setApplication(application);</span>
<span class="nc" id="L384">      appenders.addAll(log4JAccessor.getAppenders());</span>
<span class="nc" id="L385">    } catch (Exception e) {</span>
<span class="nc" id="L386">      logger.debug(&quot;Could not resolve log4j loggers for '{}'&quot;, applicationName, e);</span>
<span class="nc" id="L387">    }</span>

    // check for Logback loggers
    try {
<span class="nc" id="L391">      LogbackFactoryAccessor logbackAccessor = new LogbackFactoryAccessor(cl);</span>
<span class="nc" id="L392">      logbackAccessor.setApplication(application);</span>
<span class="nc" id="L393">      appenders.addAll(logbackAccessor.getAppenders());</span>
<span class="nc" id="L394">    } catch (Exception e) {</span>
<span class="nc" id="L395">      logger.debug(&quot;Could not resolve logback loggers for '{}'&quot;, applicationName, e);</span>
<span class="nc" id="L396">    }</span>

    // check for tomcat-slf4j-logback loggers
    try {
<span class="nc" id="L400">      TomcatSlf4jLogbackFactoryAccessor tomcatSlf4jLogbackAccessor =</span>
          new TomcatSlf4jLogbackFactoryAccessor(cl);
<span class="nc" id="L402">      tomcatSlf4jLogbackAccessor.setApplication(application);</span>
<span class="nc" id="L403">      appenders.addAll(tomcatSlf4jLogbackAccessor.getAppenders());</span>
<span class="nc" id="L404">    } catch (Exception e) {</span>
<span class="nc" id="L405">      logger.debug(&quot;Could not resolve tomcat-slf4j-logback loggers for '{}'&quot;, applicationName, e);</span>
<span class="nc" id="L406">    }</span>
<span class="nc" id="L407">  }</span>

  /**
   * Interrogate std out files.
   *
   * @param appenders the appenders
   */
  private void interrogateStdOutFiles(List&lt;LogDestination&gt; appenders) {
<span class="nc bnc" id="L415" title="All 2 branches missed.">    for (String fileName : stdoutFiles) {</span>
<span class="nc" id="L416">      FileLogAccessor fla = resolveStdoutLogDestination(fileName);</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">      if (fla != null) {</span>
<span class="nc" id="L418">        appenders.add(fla);</span>
      }
<span class="nc" id="L420">    }</span>
<span class="nc" id="L421">  }</span>

  /**
   * Gets the stdout log destination.
   *
   * @param logName the log name
   * @return the stdout log destination
   */
  private LogDestination getStdoutLogDestination(String logName) {
<span class="nc bnc" id="L430" title="All 2 branches missed.">    for (String fileName : stdoutFiles) {</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">      if (fileName.equals(logName)) {</span>
<span class="nc" id="L432">        FileLogAccessor fla = resolveStdoutLogDestination(fileName);</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">        if (fla != null) {</span>
<span class="nc" id="L434">          return fla;</span>
        }
      }
<span class="nc" id="L437">    }</span>
<span class="nc" id="L438">    return null;</span>
  }

  /**
   * Resolve stdout log destination.
   *
   * @param fileName the file name
   * @return the file log accessor
   */
  private FileLogAccessor resolveStdoutLogDestination(String fileName) {
<span class="nc" id="L448">    File stdout = new File(System.getProperty(&quot;catalina.base&quot;), &quot;logs/&quot; + fileName);</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">    if (stdout.exists()) {</span>
<span class="nc" id="L450">      FileLogAccessor fla = new FileLogAccessor();</span>
<span class="nc" id="L451">      fla.setName(fileName);</span>
<span class="nc" id="L452">      fla.setFile(stdout);</span>
<span class="nc" id="L453">      return fla;</span>
    }
<span class="nc" id="L455">    return null;</span>
  }

  /**
   * Gets the catalina log destination.
   *
   * @param ctx the ctx
   * @param application the application
   * @return the catalina log destination
   */
  private LogDestination getCatalinaLogDestination(Context ctx, Application application) {
<span class="nc" id="L466">    Object log = ctx.getLogger();</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">    if (log != null) {</span>
<span class="nc" id="L468">      CatalinaLoggerAccessor logAccessor = new CatalinaLoggerAccessor();</span>
<span class="nc" id="L469">      logAccessor.setTarget(log);</span>
<span class="nc" id="L470">      logAccessor.setApplication(application);</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">      if (logAccessor.getFile().exists()) {</span>
<span class="nc" id="L472">        return logAccessor;</span>
      }
    }
<span class="nc" id="L475">    return null;</span>
  }

  /**
   * Gets the commons log destination.
   *
   * @param ctx the ctx
   * @param application the application
   * @param logIndex the log index
   * @return the commons log destination
   */
  private LogDestination getCommonsLogDestination(Context ctx, Application application,
      String logIndex) {
<span class="nc" id="L488">    Object contextLogger = ctx.getLogger();</span>
<span class="nc" id="L489">    CommonsLoggerAccessor commonsAccessor = new CommonsLoggerAccessor();</span>
<span class="nc" id="L490">    commonsAccessor.setTarget(contextLogger);</span>
<span class="nc" id="L491">    commonsAccessor.setApplication(application);</span>
<span class="nc" id="L492">    return commonsAccessor.getDestination(logIndex);</span>
  }

  /**
   * Gets the jdk14 log destination.
   *
   * @param cl the cl
   * @param application the application
   * @param root the root
   * @param logName the log name
   * @param handlerIndex the handler index
   * @return the jdk14 log destination
   */
  private LogDestination getJdk14LogDestination(ClassLoader cl, Application application,
      boolean root, String logName, String handlerIndex) {

    try {
<span class="nc" id="L509">      Jdk14ManagerAccessor manager = new Jdk14ManagerAccessor(cl);</span>
<span class="nc" id="L510">      manager.setApplication(application);</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">      Jdk14LoggerAccessor log = root ? manager.getRootLogger() : manager.getLogger(logName);</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">      if (log != null) {</span>
<span class="nc" id="L513">        return log.getHandler(handlerIndex);</span>
      }
<span class="nc" id="L515">    } catch (Exception e) {</span>
<span class="nc" id="L516">      logger.debug(&quot;getJdk14LogDestination failed&quot;, e);</span>
<span class="nc" id="L517">    }</span>
<span class="nc" id="L518">    return null;</span>
  }

  /**
   * Gets the log4j log destination.
   *
   * @param cl the cl
   * @param application the application
   * @param root the root
   * @param logName the log name
   * @param appenderName the appender name
   * @return the log4j log destination
   */
  private LogDestination getLog4JLogDestination(ClassLoader cl, Application application,
      boolean root, String logName, String appenderName) {

    try {
<span class="nc" id="L535">      Log4JManagerAccessor manager = new Log4JManagerAccessor(cl);</span>
<span class="nc" id="L536">      manager.setApplication(application);</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">      Log4JLoggerAccessor log = root ? manager.getRootLogger() : manager.getLogger(logName);</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">      if (log != null) {</span>
<span class="nc" id="L539">        return log.getAppender(appenderName);</span>
      }
<span class="nc" id="L541">    } catch (Exception e) {</span>
<span class="nc" id="L542">      logger.debug(&quot;getLog4JLogDestination failed&quot;, e);</span>
<span class="nc" id="L543">    }</span>
<span class="nc" id="L544">    return null;</span>
  }

  /**
   * Gets the log4j2 log destination.
   *
   * @param ctx the ctx
   * @param application the application
   * @param root the root
   * @param logName the log name
   * @param appenderName the appender name
   * @return the log4j2 log destination
   */
  private LogDestination getLog4J2LogDestination(Context ctx, Application application, boolean root,
      String logName, String appenderName) {

<span class="nc" id="L560">    Log4J2AppenderAccessor result = null;</span>
    try {
<span class="nc" id="L562">      Loader loader = ctx.getLoader();</span>
<span class="nc" id="L563">      ClassLoader classLoader = loader.getClassLoader();</span>
<span class="nc" id="L564">      Log4J2WebLoggerContextUtilsAccessor webLoggerContextUtilsAccessor =</span>
          new Log4J2WebLoggerContextUtilsAccessor(classLoader);
<span class="nc" id="L566">      Log4J2LoggerContextAccessor loggerContextAccessor =</span>
<span class="nc" id="L567">          webLoggerContextUtilsAccessor.getWebLoggerContext(ctx.getServletContext());</span>
<span class="nc" id="L568">      List&lt;Object&gt; loggerContexts = getLoggerContexts(classLoader);</span>
<span class="nc" id="L569">      Object loggerConfig = null;</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">      for (Object loggerContext : loggerContexts) {</span>
<span class="nc" id="L571">        Map&lt;String, Object&gt; loggerConfigs = getLoggerConfigs(loggerContext);</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">        loggerConfig = loggerConfigs.get(root ? &quot;&quot; : logName);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">        if (loggerConfig != null) {</span>
<span class="nc" id="L574">          break;</span>
        }
<span class="nc" id="L576">      }</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">      if (loggerConfig != null) {</span>
<span class="nc" id="L578">        Log4J2LoggerConfigAccessor accessor = new Log4J2LoggerConfigAccessor();</span>
<span class="nc" id="L579">        accessor.setTarget(loggerConfig);</span>
<span class="nc" id="L580">        accessor.setApplication(application);</span>
<span class="nc" id="L581">        accessor.setContext(true);</span>
<span class="nc" id="L582">        accessor.setLoggerContext(loggerContextAccessor);</span>
<span class="nc" id="L583">        result = accessor.getAppender(appenderName);</span>
      }
<span class="nc" id="L585">    } catch (Exception e) {</span>
<span class="nc" id="L586">      logger.debug(&quot;getLog4J2LogDestination failed&quot;, e);</span>
<span class="nc" id="L587">    }</span>
<span class="nc" id="L588">    logger.debug(&quot;getLog4J2LogDestination(): OUT: result={}&quot;, result);</span>

<span class="nc" id="L590">    return result;</span>
  }

  private Map&lt;String, Object&gt; getLoggerConfigs(Object loggerContext)
      throws IllegalAccessException, InvocationTargetException {
<span class="nc" id="L595">    Method getConfiguration =</span>
<span class="nc" id="L596">        MethodUtils.getAccessibleMethod(loggerContext.getClass(), &quot;getConfiguration&quot;);</span>
<span class="nc" id="L597">    Object configuration = getConfiguration.invoke(loggerContext);</span>
<span class="nc" id="L598">    Method getLoggerConfigs =</span>
<span class="nc" id="L599">        MethodUtils.getAccessibleMethod(configuration.getClass(), &quot;getLoggers&quot;);</span>
<span class="nc" id="L600">    return (Map&lt;String, Object&gt;) getLoggerConfigs.invoke(configuration);</span>
  }

  private List&lt;Object&gt; getLoggerContexts(ClassLoader cl) throws ClassNotFoundException,
      InstantiationException, IllegalAccessException, InvocationTargetException,
      IllegalArgumentException, NoSuchMethodException, SecurityException {
<span class="nc" id="L606">    Class&lt;?&gt; clazz =</span>
<span class="nc" id="L607">        cl.loadClass(&quot;org.apache.logging.log4j.core.selector.ClassLoaderContextSelector&quot;);</span>
<span class="nc" id="L608">    Object classLoaderContextSelector = clazz.getDeclaredConstructor().newInstance();</span>
<span class="nc" id="L609">    Method getLoggerContexts = MethodUtils.getAccessibleMethod(clazz, &quot;getLoggerContexts&quot;);</span>
<span class="nc" id="L610">    return (List&lt;Object&gt;) getLoggerContexts.invoke(classLoaderContextSelector);</span>
  }

  /**
   * Gets the logback log destination.
   *
   * @param cl the cl
   * @param application the application
   * @param root the root
   * @param logName the log name
   * @param appenderName the appender name
   * @return the logback log destination
   */
  private LogDestination getLogbackLogDestination(ClassLoader cl, Application application,
      boolean root, String logName, String appenderName) {

    try {
<span class="nc" id="L627">      LogbackFactoryAccessor manager = new LogbackFactoryAccessor(cl);</span>
<span class="nc" id="L628">      manager.setApplication(application);</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">      LogbackLoggerAccessor log = root ? manager.getRootLogger() : manager.getLogger(logName);</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">      if (log != null) {</span>
<span class="nc" id="L631">        return log.getAppender(appenderName);</span>
      }
<span class="nc" id="L633">    } catch (Exception e) {</span>
<span class="nc" id="L634">      logger.debug(&quot;getLogbackLogDestination failed&quot;, e);</span>
<span class="nc" id="L635">    }</span>
<span class="nc" id="L636">    return null;</span>
  }

  /**
   * Gets the logback tomcat juli log destination.
   *
   * @param cl the cl
   * @param application the application
   * @param root the root
   * @param logName the log name
   * @param appenderName the appender name
   * @return the logback tomcat juli log destination
   */
  private LogDestination getLogbackTomcatJuliLogDestination(ClassLoader cl, Application application,
      boolean root, String logName, String appenderName) {

    try {
<span class="nc" id="L653">      TomcatSlf4jLogbackFactoryAccessor manager = new TomcatSlf4jLogbackFactoryAccessor(cl);</span>
<span class="nc" id="L654">      manager.setApplication(application);</span>
      TomcatSlf4jLogbackLoggerAccessor log =
<span class="nc bnc" id="L656" title="All 2 branches missed.">          root ? manager.getRootLogger() : manager.getLogger(logName);</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">      if (log != null) {</span>
<span class="nc" id="L658">        return log.getAppender(appenderName);</span>
      }
<span class="nc" id="L660">    } catch (Exception e) {</span>
<span class="nc" id="L661">      logger.debug(&quot;getTomcatSlf4jLogbackLogDestination failed&quot;, e);</span>
<span class="nc" id="L662">    }</span>
<span class="nc" id="L663">    return null;</span>
  }

  /**
   * The Class AbstractLogComparator.
   */
  private abstract static class AbstractLogComparator
      implements Comparator&lt;LogDestination&gt;, Serializable {

    /** The Constant serialVersionUID. */
    private static final long serialVersionUID = 1L;

    /** The Constant DELIM. */
    protected static final char DELIM = '!';

    @Override
    public final int compare(LogDestination o1, LogDestination o2) {
<span class="nc" id="L680">      String name1 = convertToString(o1);</span>
<span class="nc" id="L681">      String name2 = convertToString(o2);</span>
<span class="nc" id="L682">      return name1.compareTo(name2);</span>
    }

    /**
     * Convert to string.
     *
     * @param d1 the d1
     * @return the string
     */
    protected abstract String convertToString(LogDestination d1);

  }

  /**
   * The Class LogDestinationComparator.
   */
  private static class LogDestinationComparator extends AbstractLogComparator
      implements Serializable {

    /** The Constant serialVersionUID. */
    private static final long serialVersionUID = 1L;

    /** The all. */
    private final boolean all;

    /**
     * Instantiates a new log destination comparator.
     *
     * @param all the all
     */
<span class="nc" id="L712">    public LogDestinationComparator(boolean all) {</span>
<span class="nc" id="L713">      this.all = all;</span>
<span class="nc" id="L714">    }</span>

    @Override
    protected String convertToString(LogDestination dest) {
<span class="nc" id="L718">      File file = dest.getFile();</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">      String fileName = file == null ? &quot;&quot; : file.getAbsolutePath();</span>
      String name;
<span class="nc bnc" id="L721" title="All 2 branches missed.">      if (all) {</span>
<span class="nc" id="L722">        Application app = dest.getApplication();</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">        String appName = app == null ? Character.toString(DELIM) : app.getName();</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">        String context = dest.isContext() ? &quot;is&quot; : &quot;not&quot;;</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">        String root = dest.isRoot() ? &quot;is&quot; : &quot;not&quot;;</span>
<span class="nc" id="L726">        String logType = dest.getLogType();</span>
<span class="nc" id="L727">        name = appName + DELIM + context + DELIM + root + DELIM + logType + DELIM + fileName;</span>
<span class="nc" id="L728">      } else {</span>
<span class="nc" id="L729">        name = fileName;</span>
      }
<span class="nc" id="L731">      return name;</span>
    }

  }

  /**
   * The Class LogSourceComparator.
   */
<span class="nc" id="L739">  private static class LogSourceComparator extends AbstractLogComparator implements Serializable {</span>

    /** The Constant serialVersionUID. */
    private static final long serialVersionUID = 1L;

    @Override
    protected String convertToString(LogDestination dest) {
<span class="nc" id="L746">      File file = dest.getFile();</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">      String fileName = file == null ? &quot;&quot; : file.getAbsolutePath();</span>
<span class="nc" id="L748">      Application app = dest.getApplication();</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">      String appName = app == null ? Character.toString(DELIM) : app.getName();</span>
<span class="nc" id="L750">      String logType = dest.getLogType();</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">      String context = dest.isContext() ? &quot;is&quot; : &quot;not&quot;;</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">      String root = dest.isRoot() ? &quot;is&quot; : &quot;not&quot;;</span>
<span class="nc" id="L753">      String logName = dest.getName();</span>
<span class="nc" id="L754">      return appName + DELIM + logType + DELIM + context + DELIM + root + DELIM + logName + DELIM</span>
          + fileName;
    }

  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>