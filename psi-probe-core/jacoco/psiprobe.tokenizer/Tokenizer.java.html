<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Tokenizer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe.tokenizer</a> &gt; <span class="el_source">Tokenizer.java</span></div><h1>Tokenizer.java</h1><pre class="source lang-java linenums">/**
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe.tokenizer;

import java.io.IOException;
import java.io.Reader;
import java.util.Collections;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * The Class Tokenizer.
 */
public class Tokenizer {

  /** The Constant logger. */
<span class="nc" id="L27">  private static final Logger logger = LoggerFactory.getLogger(Tokenizer.class);</span>

  /** The Constant TT_TOKEN. */
  public static final int TT_TOKEN = 0;

  /** The Constant TT_SYMBOL. */
  public static final int TT_SYMBOL = 1;

  /** The Constant TT_BLOCK. */
  public static final int TT_BLOCK = 2;

  /** The Constant TT_ERROR. */
  public static final int TT_ERROR = 3;

  /** The reader. */
  private Reader reader;

  /** The symbols. */
  private final List&lt;TokenizerSymbol&gt; symbols;

  /** The push count. */
  private int pushCount;

  /** The token. */
  private final TokenizerToken token;

  /** The upcoming token. */
  private final TokenizerToken upcomingToken;

  /** The cache position. */
  private int cachePosition;

  /** The cache size. */
  private int cacheSize;

  /** The cache buffer. */
  private final char[] cacheBuffer;

  /** The cache pin position. */
  private int cachePinPosition;

  /**
   * Instantiates a new tokenizer.
   */
  public Tokenizer() {
<span class="nc" id="L72">    this(null, 4096);</span>
<span class="nc" id="L73">  }</span>

  /**
   * Instantiates a new tokenizer.
   *
   * @param reader the reader
   */
  public Tokenizer(Reader reader) {
<span class="nc" id="L81">    this(reader, 4096);</span>
<span class="nc" id="L82">  }</span>

  /**
   * Instantiates a new tokenizer.
   *
   * @param reader the reader
   * @param cacheBufferSize the cache buffer size
   */
<span class="nc" id="L90">  public Tokenizer(Reader reader, int cacheBufferSize) {</span>
<span class="nc" id="L91">    symbols = new UniqueList&lt;&gt;();</span>
<span class="nc" id="L92">    token = new TokenizerToken();</span>
<span class="nc" id="L93">    upcomingToken = new TokenizerToken();</span>
<span class="nc" id="L94">    cacheBuffer = new char[cacheBufferSize];</span>
<span class="nc" id="L95">    setReader(reader);</span>
<span class="nc" id="L96">  }</span>

  /**
   * Load cache.
   *
   * @param count the count
   * @throws IOException Signals that an I/O exception has occurred.
   */
  private void loadCache(int count) throws IOException {
<span class="nc bnc" id="L105" title="All 2 branches missed.">    int charToRead = count == 0 ? 0 : count - 1;</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">    if (cachePosition + charToRead &gt;= cacheSize) {</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">      if (cacheSize == 0) {</span>
<span class="nc" id="L108">        cacheSize = reader.read(cacheBuffer, 0, cacheBuffer.length);</span>
<span class="nc" id="L109">        cachePosition = 0;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">      } else if (cacheSize == cacheBuffer.length) {</span>
        // make sure we do not read beyond the stream
<span class="nc" id="L112">        int halfCacheSize = cacheSize / 2;</span>
        // copy the lower half into the upper half
<span class="nc" id="L114">        System.arraycopy(cacheBuffer, halfCacheSize, cacheBuffer, 0, halfCacheSize);</span>
<span class="nc" id="L115">        cachePosition -= halfCacheSize;</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (cachePinPosition != -1) {</span>
<span class="nc" id="L117">          cachePinPosition -= halfCacheSize;</span>
        }

<span class="nc" id="L120">        int charsRead = reader.read(cacheBuffer, halfCacheSize, cacheSize - halfCacheSize);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (charsRead == -1) {</span>
<span class="nc" id="L122">          cacheSize = halfCacheSize;</span>
        } else {
<span class="nc" id="L124">          cacheSize = charsRead + halfCacheSize;</span>
        }
      }
    }
<span class="nc" id="L128">  }</span>

  /**
   * Gets the token.
   *
   * @return the token
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public Token getToken() throws IOException {
<span class="nc bnc" id="L137" title="All 2 branches missed.">    if (token.type == Tokenizer.TT_ERROR) {</span>
<span class="nc" id="L138">      return nextToken();</span>
    }
<span class="nc" id="L140">    return token;</span>
  }

  /**
   * Next token.
   *
   * @return the token
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public Token nextToken() throws IOException {
<span class="nc bnc" id="L150" title="All 2 branches missed.">    if (pushCount &gt; 0) {</span>
<span class="nc" id="L151">      pushCount--;</span>
<span class="nc" id="L152">      return token;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">    } else if (upcomingToken.type != Tokenizer.TT_ERROR) {</span>
<span class="nc" id="L154">      token.assign(upcomingToken);</span>
<span class="nc" id="L155">      upcomingToken.type = Tokenizer.TT_ERROR;</span>
<span class="nc" id="L156">      return token;</span>
    } else {
<span class="nc" id="L158">      token.init();</span>
<span class="nc" id="L159">      char[] chr = new char[1];</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">      while (hasMore()) {</span>
<span class="nc" id="L161">        read(chr, 1);</span>

<span class="nc" id="L163">        int symbolIndex = lookupSymbol(chr[0]);</span>

<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (symbolIndex != -1) {</span>
          // we have found a symbol
          TokenizerToken workToken =
<span class="nc bnc" id="L168" title="All 4 branches missed.">              token.type == Tokenizer.TT_TOKEN &amp;&amp; token.text.length() &gt; 0 ? upcomingToken : token;</span>
<span class="nc" id="L169">          TokenizerSymbol symbol = symbols.get(symbolIndex);</span>
<span class="nc" id="L170">          boolean hideSymbol = symbol.hidden;</span>

<span class="nc bnc" id="L172" title="All 2 branches missed.">          if (!hideSymbol) {</span>
<span class="nc" id="L173">            workToken.init();</span>
<span class="nc" id="L174">            workToken.text.append(symbol.startText);</span>
<span class="nc" id="L175">            workToken.type = Tokenizer.TT_SYMBOL;</span>
<span class="nc" id="L176">            workToken.name = symbol.name;</span>
          }

<span class="nc bnc" id="L179" title="All 2 branches missed.">          if (symbol.tailText != null) {</span>
            // the symbol is a block
            // look for the tailText
<span class="nc bnc" id="L182" title="All 4 branches missed.">            while (hasMore() &amp;&amp; !compare(symbol.tailText.toCharArray(), 0)) {</span>
<span class="nc" id="L183">              read(chr, 1);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">              if (!hideSymbol) {</span>
<span class="nc" id="L185">                workToken.text.append(chr);</span>
<span class="nc" id="L186">                workToken.innerText.append(chr);</span>
              }
            }

<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (!hideSymbol) {</span>
<span class="nc" id="L191">              workToken.text.append(symbol.tailText);</span>
            }
<span class="nc" id="L193">            workToken.type = Tokenizer.TT_BLOCK;</span>
          }

<span class="nc bnc" id="L196" title="All 2 branches missed.">          if (token.text.length() &gt; 0) {</span>
<span class="nc" id="L197">            break;</span>
          }
<span class="nc" id="L199">        } else {</span>
<span class="nc" id="L200">          token.text.append(chr);</span>
<span class="nc" id="L201">          token.type = Tokenizer.TT_TOKEN;</span>
        }
<span class="nc" id="L203">      }</span>
    }
<span class="nc" id="L205">    return token;</span>
  }

  /**
   * Push back.
   */
  public void pushBack() {
<span class="nc" id="L212">    pushCount++;</span>
<span class="nc" id="L213">  }</span>

  /**
   * Sets the reader.
   *
   * @param reader the new reader
   */
  public void setReader(Reader reader) {
<span class="nc" id="L221">    this.reader = reader;</span>
<span class="nc" id="L222">    cachePosition = 0;</span>
<span class="nc" id="L223">    cachePinPosition = -1;</span>
<span class="nc" id="L224">    cacheSize = 0;</span>
<span class="nc" id="L225">    token.type = TT_ERROR;</span>
<span class="nc" id="L226">    upcomingToken.type = TT_ERROR;</span>
<span class="nc" id="L227">  }</span>

  /**
   * Compare.
   *
   * @param chars the chars
   * @param offs the offs
   * @return true, if successful
   * @throws IOException Signals that an I/O exception has occurred.
   */
  private boolean compare(char[] chars, int offs) throws IOException {
<span class="nc" id="L238">    char[] subStr = new char[chars.length - offs];</span>
<span class="nc" id="L239">    cachePinPosition = cachePosition;</span>
<span class="nc" id="L240">    read(subStr, subStr.length);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">    for (int i = 0; i &lt; subStr.length; i++) {</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">      if (subStr[i] != chars[i + offs]) {</span>
<span class="nc" id="L243">        cachePosition = cachePinPosition;</span>
<span class="nc" id="L244">        cachePinPosition = -1;</span>
<span class="nc" id="L245">        return false;</span>
      }
    }
<span class="nc" id="L248">    return true;</span>
  }

  /**
   * Lookup symbol.
   *
   * @param chr the chr
   * @return the int
   * @throws IOException Signals that an I/O exception has occurred.
   */
  private int lookupSymbol(char chr) throws IOException {
<span class="nc" id="L259">    int result = -1;</span>

<span class="nc" id="L261">    Character chrObj = chr;</span>
<span class="nc" id="L262">    int index = Collections.binarySearch(symbols, chrObj);</span>

<span class="nc bnc" id="L264" title="All 2 branches missed.">    if (index &gt;= 0) {</span>
      // the index could be anywhere within a group of symbols with the same first letter
      // so we need to scroll up the group to make sure we start test from the beginning
<span class="nc bnc" id="L267" title="All 4 branches missed.">      while (index &gt; 0 &amp;&amp; symbols.get(index - 1).compareTo(chrObj) == 0) {</span>
<span class="nc" id="L268">        index--;</span>
      }
<span class="nc bnc" id="L270" title="All 2 branches missed.">      while (index &lt; symbols.size()) {</span>
<span class="nc" id="L271">        TokenizerSymbol symbol = symbols.get(index);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (symbol.compareTo(chrObj) == 0) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">          if (compare(symbol.startText.toCharArray(), 1)) {</span>
<span class="nc" id="L274">            result = index;</span>
<span class="nc" id="L275">            break;</span>
          }
<span class="nc" id="L277">          index++;</span>
        } else {
          break;
        }
<span class="nc" id="L281">      }</span>
    }
<span class="nc" id="L283">    return result;</span>
  }

  /**
   * Read.
   *
   * @param chrs the chrs
   * @param count the count
   * @throws IOException Signals that an I/O exception has occurred.
   */
  private void read(char[] chrs, int count) throws IOException {
<span class="nc" id="L294">    loadCache(count);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">    int endPoint = cachePosition + count - 1 &gt;= cacheSize ? cacheSize : cachePosition + count - 1;</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">    if (cachePosition &lt;= endPoint) {</span>
<span class="nc" id="L297">      System.arraycopy(cacheBuffer, cachePosition, chrs, 0, endPoint - cachePosition + 1);</span>
    }
<span class="nc" id="L299">    cachePosition = endPoint + 1;</span>
<span class="nc" id="L300">  }</span>

  /**
   * Checks for more.
   *
   * @return true, if successful
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public boolean hasMore() throws IOException {
<span class="nc" id="L309">    loadCache(0);</span>
<span class="nc bnc" id="L310" title="All 6 branches missed.">    return cachePosition &lt; cacheSize || upcomingToken.type != Tokenizer.TT_ERROR || pushCount &gt; 0;</span>
  }

  /**
   * Adds the symbol.
   *
   * @param text the text
   */
  public void addSymbol(String text) {
<span class="nc" id="L319">    symbols.add(new TokenizerSymbol(null, text, null, false, false, true, false));</span>
<span class="nc" id="L320">  }</span>

  /**
   * Adds the symbol.
   *
   * @param text the text
   * @param hidden the hidden
   */
  public void addSymbol(String text, boolean hidden) {
<span class="nc" id="L329">    symbols.add(new TokenizerSymbol(null, text, null, hidden, false, true, false));</span>
<span class="nc" id="L330">  }</span>

  /**
   * Adds the symbol.
   *
   * @param startText the start text
   * @param endText the end text
   * @param hidden the hidden
   */
  public void addSymbol(String startText, String endText, boolean hidden) {
<span class="nc" id="L340">    symbols.add(new TokenizerSymbol(null, startText, endText, hidden, false, true, false));</span>
<span class="nc" id="L341">  }</span>

  /**
   * Adds the symbol.
   *
   * @param symbol the symbol
   */
  public void addSymbol(TokenizerSymbol symbol) {
<span class="nc" id="L349">    symbols.add(symbol);</span>
<span class="nc" id="L350">  }</span>

  /**
   * Gets the next string.
   *
   * @param defaultValue the default value
   * @return the next string
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public String getNextString(String defaultValue) throws IOException {
<span class="nc bnc" id="L360" title="All 2 branches missed.">    return hasMore() ? nextToken().getInnerText() : defaultValue;</span>
  }

  /**
   * Gets the next boolean.
   *
   * @param trueValue the true value
   * @param defaultValue the default value
   * @return the next boolean
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public boolean getNextBoolean(String trueValue, boolean defaultValue) throws IOException {
<span class="nc bnc" id="L372" title="All 2 branches missed.">    return hasMore() ? trueValue.equalsIgnoreCase(nextToken().getInnerText()) : defaultValue;</span>
  }

  /**
   * Gets the next long.
   *
   * @param defaultValue the default value
   * @return the next long
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public long getNextLong(long defaultValue) throws IOException {
<span class="nc" id="L383">    String stval = getNextString(null);</span>

<span class="nc bnc" id="L385" title="All 2 branches missed.">    if (stval == null) {</span>
<span class="nc" id="L386">      return defaultValue;</span>
    }

    try {
<span class="nc" id="L390">      return Long.parseLong(stval);</span>
<span class="nc" id="L391">    } catch (NumberFormatException e) {</span>
<span class="nc" id="L392">      logger.trace(&quot;&quot;, e);</span>
<span class="nc" id="L393">      return defaultValue;</span>
    }
  }

  /**
   * The Class TokenizerToken.
   */
  private static class TokenizerToken implements Token {

    /** The text. */
<span class="nc" id="L403">    final StringBuilder text = new StringBuilder();</span>

    /** The inner text. */
<span class="nc" id="L406">    final StringBuilder innerText = new StringBuilder();</span>

    /** The name. */
<span class="nc" id="L409">    String name = &quot;&quot;;</span>

    /** The type. */
<span class="nc" id="L412">    int type = Tokenizer.TT_ERROR;</span>

    /** The line. */
<span class="nc" id="L415">    int line = 0;</span>

    /** The col. */
<span class="nc" id="L418">    int col = 0;</span>

    /**
     * Instantiates a new tokenizer token.
     */
<span class="nc" id="L423">    public TokenizerToken() {</span>
<span class="nc" id="L424">      type = Tokenizer.TT_ERROR;</span>
<span class="nc" id="L425">    }</span>

    @Override
    public String getText() {
<span class="nc" id="L429">      return text.toString();</span>
    }

    @Override
    public String getInnerText() {
<span class="nc bnc" id="L434" title="All 2 branches missed.">      return type == Tokenizer.TT_BLOCK ? innerText.toString() : getText();</span>
    }

    @Override
    public String getName() {
<span class="nc" id="L439">      return name;</span>
    }

    @Override
    public int getType() {
<span class="nc" id="L444">      return type;</span>
    }

    @Override
    public int getLine() {
<span class="nc" id="L449">      return line;</span>
    }

    @Override
    public int getCol() {
<span class="nc" id="L454">      return col;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L459">      return getText();</span>
    }

    /**
     * Assign.
     *
     * @param token the token
     */
    public void assign(TokenizerToken token) {
<span class="nc" id="L468">      this.text.setLength(0);</span>
<span class="nc" id="L469">      this.text.append(token.text);</span>
<span class="nc" id="L470">      this.innerText.setLength(0);</span>
<span class="nc" id="L471">      this.innerText.append(token.innerText);</span>
<span class="nc" id="L472">      this.name = token.name;</span>
<span class="nc" id="L473">      this.type = token.type;</span>
<span class="nc" id="L474">      this.col = token.col;</span>
<span class="nc" id="L475">      this.line = token.line;</span>
<span class="nc" id="L476">    }</span>

    /**
     * Inits the.
     */
    public void init() {
<span class="nc" id="L482">      text.setLength(0);</span>
<span class="nc" id="L483">      innerText.setLength(0);</span>
<span class="nc" id="L484">      name = &quot;&quot;;</span>
<span class="nc" id="L485">    }</span>

  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>